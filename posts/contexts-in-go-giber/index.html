<!doctype html><html lang=en-us><head><title>Contexts in Go Fiber // a dystopian journey into the heart of tech</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.127.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Pruthvi Kumar"><meta name=description content><link rel=stylesheet href=/blog/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css><link rel=stylesheet href=/blog/css/custom.min.a1c16b97fbe8a2fd96bb78a6a5a8ebb79f1b65243c35465b41c2deefc53f5614.css integrity="sha256-ocFrl/voov2Wu3impajrt58bZSQ8NUZbQcLe78U/VhQ=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",e=>{console.log("DOM fully loaded and parsed"),typeof mermaid!="undefined"?(console.log("Mermaid found, initializing..."),mermaid.initialize({startOnLoad:!0,theme:"dark",themeVariables:{darkMode:!0,background:"#2d2d2d",primaryColor:"#ff9800",secondaryColor:"#2196f3",tertiaryColor:"#4caf50",primaryTextColor:"#fff",secondaryTextColor:"#ddd",lineColor:"#999",textColor:"#fff",mainBkg:"#2d2d2d",nodeBorder:"#7f7f7f",clusterBkg:"#3d3d3d",clusterBorder:"#888",titleColor:"#f8f8f2"}})):console.error("Mermaid not found!")})</script></head><body><header class=app-header><a href=https://1x-eng.github.io/blog/><img class=app-header-avatar src=/blog/avatar.jpg alt="Pruthvi Kumar"></a>
<span class=app-header-title>a dystopian journey into the heart of tech</span><p>confessions of a serial key puncher: the life and times of a coder.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Contexts in Go Fiber</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Jan 25, 2025</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 min read</div></div></header><div class=post-content><h1 id=-the-hidden-cost-of-context-handling-in-web-frameworks-how-i-spent-a-week-chasing-heisenbugs-and-what-it-taught-me-about-fibers-context-pool>🕵️‍♂️ The Hidden Cost of Context Handling in Web Frameworks: How I Spent a Week Chasing Heisenbugs and What It Taught Me About Fiber&rsquo;s Context Pool</h1><h2 id=1-the-mystery-intermittent-user-data-leaks->1. The Mystery: Intermittent User Data Leaks 🔍</h2><h3 id=scenario>Scenario:</h3><p>You deploy a shiny new user profile endpoint. It works perfectly in testing, but in production:</p><pre tabindex=0><code>- User A sometimes sees User B&#39;s email  
- 500 errors spike during load tests  
- Logs show impossible type assertions
</code></pre><h3 id=the-smoking-gun->The Smoking Gun: 💣</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Your innocent-looking handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GetProfile</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>fiber</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Locals</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>).(</span><span class=o>*</span><span class=nx>AuthClaims</span><span class=p>)</span> <span class=c1>// ← Time bomb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>claims</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=2-understanding-the-crime-scene-fibers-context-pool->2. Understanding the Crime Scene: Fiber&rsquo;s Context Pool 🔬</h2><h3 id=how-fiber-optimizes-performance->How Fiber Optimizes Performance: ⚡</h3><div class=mermaid>sequenceDiagram
participant Request1
participant Pool
participant Request2
Request1->>Pool: Get context
Pool->>Request1: Context A
Request1->>Pool: Return context A
Request2->>Pool: Get context
Pool->>Request2: Same context A</div><h3 id=the-perfect-storm->The Perfect Storm: ⚠️</h3><ol><li>Middleware stores *AuthClaims pointer</li><li>Handler accesses it after context reuse</li><li>Boom: Concurrent requests trample memory</li></ol><h2 id=3-forensic-analysis-benchmarks-dont-lie->3. Forensic Analysis: Benchmarks Don&rsquo;t Lie 📊</h2><h3 id=test-setup>Test Setup:</h3><ul><li>10k requests/sec load test</li><li>4 CPU cores</li><li>Fiber v2 vs Gin v1.10</li></ul><h3 id=results->Results: 🎯</h3><h4 id=-request-performance>🚀 Request Performance</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Req/Sec
</span></span><span class=line><span class=cl>├── Fiber (Unsafe) : 112k
</span></span><span class=line><span class=cl>├── Fiber (Safe)   : 98k
</span></span><span class=line><span class=cl>└── Gin           : 89k
</span></span></code></pre></td></tr></table></div></div><h4 id=-memory-usage>💾 Memory Usage</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Memory Allocation
</span></span><span class=line><span class=cl>├── Fiber (Unsafe) : 45MB
</span></span><span class=line><span class=cl>├── Fiber (Safe)   : 62MB
</span></span><span class=line><span class=cl>└── Gin           : 75MB
</span></span></code></pre></td></tr></table></div></div><h4 id=-security-impact>🔒 Security Impact</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Data Leaks
</span></span><span class=line><span class=cl>├── Fiber (Unsafe) : 1.2%
</span></span><span class=line><span class=cl>├── Fiber (Safe)   : 0%
</span></span><span class=line><span class=cl>└── Gin           : 0%
</span></span></code></pre></td></tr></table></div></div><h4 id=the-performance-tax-for-safety-12-slower-37-more-memory---cheap-insurance->The performance tax for safety: 12% slower, 37% more memory - cheap insurance 💰</h4><h2 id=4-the-escape-room-three-ways-out->4. The Escape Room: Three Ways Out 🚪</h2><h4 id=option-1-copy-by-value->Option 1: Copy by value ✨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Middleware
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>authMiddleware</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>fiber</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span> <span class=o>:=</span> <span class=nf>parseToken</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=c1>// Returns value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>c</span><span class=p>.</span><span class=nf>Locals</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>,</span> <span class=nx>claims</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GetProfile</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>fiber</span><span class=p>.</span><span class=nx>Ctx</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Locals</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>).(</span><span class=nx>AuthClaims</span><span class=p>)</span> <span class=c1>// Safe
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>fiber</span><span class=p>.</span><span class=nx>Map</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=s>&#34;Auth claims invalid type, time to panic!&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>claims</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=option-2-deep-copy-helpers->Option 2: Deep Copy Helpers 🔄</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>cloneContextValue</span><span class=p>(</span><span class=nx>src</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// JSON roundtrip: Not pretty, but safe
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>dest</span> <span class=nx>AuthClaims</span>
</span></span><span class=line><span class=cl>    <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>dest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>dest</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=option-3-maybe-a-different-framework->Option 3: Maybe a different framework? 🤔</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Gin&#39;s context is request-scoped
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GinHandler</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>MustGet</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>).(</span><span class=nx>AuthClaims</span><span class=p>)</span> <span class=c1>// Safe
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>claims</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=5-framework-philosophy-choose-your-fighter->5. Framework Philosophy: Choose Your Fighter 🥊</h2><h3 id=when-to-use-fiber>When to Use Fiber:</h3><ul><li>Prototyping rapidly</li><li>Simple CRUD with no complex middleware</li><li>You enjoy living dangerously</li></ul><h3 id=when-to-choose-alternatives>When to Choose Alternatives:</h3><ul><li>Distributed services with shared context</li><li>You value sleep over raw performance</li></ul><h2 id=tldr->TL;DR: 📝</h2><ul><li>No Pointers in Locals (Except maybe to immutable values)</li><li>Validate Then Assert - <code>if _, ok := raw.(T); !ok { ... }</code></li><li>Assume Concurrency</li></ul><blockquote><p>&ldquo;But, it&rsquo;s a simple app&rdquo; -> Famous last words ⚡</p></blockquote><h2 id=github-issue->GitHub Issue 🐛</h2><p><a href=https://github.com/gofiber/fiber/issues/3012>https://github.com/gofiber/fiber/issues/3012</a></p></div><div class=post-footer></div></article></main></body></html>