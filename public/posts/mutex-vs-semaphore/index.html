<!doctype html>
<html lang="en-us">
  <head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script>
    <title>Mutex vs Semaphore // a dystopian journey into the heart of tech</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.132.1">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Pruthvi Kumar" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/blog/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css" />

    
      
      <link rel="stylesheet" href="/blog/css/custom.min.25783b96a2de994990c45f6d25ecb8574e511f6ec4f3fa548c53e7ec99e08a66.css" />
    

    

    
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-0Q0C7S8K6Z"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-0Q0C7S8K6Z');
        }
      </script>
    
  


    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Mutex vs Semaphore">
  <meta name="twitter:description" content="Mutex vs Semaphore: The Lesser of Two Evils Mutexes and semaphores are like siblings in the synchronization primitives family — one a stickler for rules (mutex), the other more lenient but equally capable of chaos when misused (semaphore). I’ll try to dive into this family drama with a sprinkle of snark, to explore their strengths, weaknesses.. And, both drive me nuts when misused.
The Boring Theory Mutex A mutex, short for “mutual exclusion,” is like that one friend who insists on being the only one to use their fancy pen.">

    <meta property="og:url" content="http://localhost:1313/blog/posts/mutex-vs-semaphore/">
  <meta property="og:site_name" content="a dystopian journey into the heart of tech">
  <meta property="og:title" content="Mutex vs Semaphore">
  <meta property="og:description" content="Mutex vs Semaphore: The Lesser of Two Evils Mutexes and semaphores are like siblings in the synchronization primitives family — one a stickler for rules (mutex), the other more lenient but equally capable of chaos when misused (semaphore). I’ll try to dive into this family drama with a sprinkle of snark, to explore their strengths, weaknesses.. And, both drive me nuts when misused.
The Boring Theory Mutex A mutex, short for “mutual exclusion,” is like that one friend who insists on being the only one to use their fancy pen.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-15T18:36:22+10:00">
    <meta property="article:modified_time" content="2024-08-15T18:36:22+10:00">


    
    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        mermaid.initialize({
          startOnLoad: true,
          theme: 'default',
          themeVariables: {
            background: '#f4f4f4',
            primaryColor: '#007bff',
            secondaryColor: '#6c757d',
            tertiaryColor: '#28a745',
            primaryTextColor: '#212529',
            secondaryTextColor: '#495057',
            tertiaryTextColor: '#ffffff',
            lineColor: '#999999',
            fontSize: '16px'
          }
        });
      });
    </script>
  </head>
  <body>
    <header class="app-header">
      <a href="http://localhost:1313/blog/"><img class="app-header-avatar" src="/blog/avatar.jpg" alt="Pruthvi Kumar" /></a>
      <span class="app-header-title">a dystopian journey into the heart of tech</span>
      <p>confessions of a serial key puncher: the life and times of a coder.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/1x-eng" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://au.linkedin.com/in/iampruthvi" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>Linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="https://stackoverflow.com/users/10019687/pruthvi-kumar" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-layers">
  <title>Stackoverflow</title>
  <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Mutex vs Semaphore</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 15, 2024
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          9 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <h1 id="mutex-vs-semaphore-the-lesser-of-two-evils">Mutex vs Semaphore: The Lesser of Two Evils</h1>
<p>Mutexes and semaphores are like siblings in the synchronization primitives family — one a stickler for rules (mutex), the other more lenient but equally capable of chaos when misused (semaphore). I&rsquo;ll try to dive into this family drama with a sprinkle of snark, to explore their strengths, weaknesses.. And, both drive me nuts when misused.</p>
<h1 id="the-boring-theory">The Boring Theory</h1>
<h2 id="mutex">Mutex</h2>
<p>A mutex, short for &ldquo;mutual exclusion,&rdquo; is like that one friend who insists on being the only one to use their fancy pen. It&rsquo;s a locking mechanism that ensures only one thread can access a shared resource at a time.</p>
<div class="mermaid">sequenceDiagram
    participant T1 as Thread 1
    participant M as Mutex
    participant R as Resource
    participant T2 as Thread 2

    T1->>M: Lock
    M->>T1: Granted
    T1->>R: Access
    T2->>M: Lock (Blocked)
    T1->>R: Finish
    T1->>M: Unlock
    M->>T2: Granted
    T2->>R: Access
</div><h2 id="semaphore">Semaphore</h2>
<p>A semaphore, on the other hand, is a signaling mechanism. It can control access by multiple threads using a counter. When the counter is greater than zero, a thread can proceed and decrement the counter. When it hits zero, threads block until the counter is incremented.</p>
<p>Loosely speaking, a semaphore is like a nightclub bouncer with a clicker. It allows a specified number of threads to access a resource concurrently. When the limit is reached, newcomers have to wait until someone leaves.</p>
<div class="mermaid">sequenceDiagram
    participant T1 as Thread 1
    participant T2 as Thread 2
    participant S as Semaphore (2)
    participant R as Resource
    participant T3 as Thread 3

    T1->>S: Acquire
    S->>T1: Granted (1 left)
    T2->>S: Acquire
    S->>T2: Granted (0 left)
    T1->>R: Access
    T2->>R: Access
    T3->>S: Acquire (Blocked)
    T1->>S: Release
    S->>T3: Granted
    T3->>R: Access
</div><h1 id="the-good-the-bad-and-the-ugly">The Good, The Bad, and The Ugly</h1>
<h2 id="mutex-when-one-is-the-loneliest-number-and-thats-good">Mutex: When One Is the Loneliest Number (And That&rsquo;s Good)</h2>
<p>Use a mutex when:</p>
<ol>
<li>You have a critical section that absolutely must be executed by only one thread at a time.</li>
<li>You need to protect shared data from race conditions.</li>
<li>You want to ensure the atomicity of a complex operation.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">BankAccount</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kt">decimal</span> <span class="n">balance</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">lockObject</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="k">void</span> <span class="n">Deposit</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">lock</span> <span class="p">(</span><span class="n">lockObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="c1">// Critical section</span>
</span></span><span class="line"><span class="cl">           <span class="n">balance</span> <span class="p">+=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">bool</span> <span class="n">Withdraw</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">lock</span> <span class="p">(</span><span class="n">lockObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="k">if</span> <span class="p">(</span><span class="n">balance</span> <span class="p">&gt;=</span> <span class="n">amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">balance</span> <span class="p">-=</span> <span class="n">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">           <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="semaphore-when-you-need-to-control-the-party">Semaphore: When You Need to Control the Party</h2>
<p>Use a semaphore when:</p>
<ol>
<li>You want to limit the number of threads that can access a resource concurrently.</li>
<li>You&rsquo;re implementing a producer-consumer pattern.</li>
<li>You need to synchronize access to a pool of resources.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Connection</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Connection implementation</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ConnectionPool</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Connection</span><span class="p">&gt;</span> <span class="n">connections</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Connection</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">SemaphoreSlim</span> <span class="n">semaphore</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ConnectionPool</span><span class="p">(</span><span class="kt">int</span> <span class="n">maxConnections</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">semaphore</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SemaphoreSlim</span><span class="p">(</span><span class="n">maxConnections</span><span class="p">,</span> <span class="n">maxConnections</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">maxConnections</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connections</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Connection</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Connection</span><span class="p">&gt;</span> <span class="n">GetConnectionAsync</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">semaphore</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">connections</span><span class="p">[</span><span class="n">connections</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">ReleaseConnection</span><span class="p">(</span><span class="n">Connection</span> <span class="n">connection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">connections</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">semaphore</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="the-pitfalls-where-good-intentions-go-to-die">The Pitfalls: Where Good Intentions Go to Die</h2>
<p>Now, let&rsquo;s talk about &lsquo;cases&rsquo; when &lsquo;some&rsquo; of us manage to royally screw things up. Buckle up, because this is where it gets painful.</p>
<h3 id="deadlocks-the-eternal-standoff">Deadlocks: The Eternal Standoff</h3>
<p>Picture two threads, each holding a resource the other needs. They&rsquo;re locked in a deadly embrace, waiting for the other to blink first. This, my friends, is a deadlock.</p>
<div class="mermaid">graph TD
    A[Thread A] -->|Holds| R1[Resource 1]
    B[Thread B] -->|Holds| R2[Resource 2]
    A -->|Wants| R2
    B -->|Wants| R1
</div><p>To avoid this nightmare:</p>
<ol>
<li>Always acquire locks in a consistent order.</li>
<li>Use timeouts when acquiring locks.</li>
<li>Implement deadlock detection and recovery mechanisms.</li>
</ol>
<h3 id="priority-inversion-when-the-vip-gets-stuck-behind-the-bouncer">Priority Inversion: When the VIP Gets Stuck Behind the Bouncer</h3>
<p>Imagine a high-priority thread waiting for a low-priority thread to release a lock. Meanwhile, a medium-priority thread keeps preempting the low-priority thread. It&rsquo;s like a VIP stuck behind the bouncer while regular patrons keep streaming in.</p>
<p>To mitigate this:</p>
<ol>
<li>Use priority inheritance protocols.</li>
<li>Minimize the time locks are held.</li>
<li>Consider lock-free algorithms for performance-critical sections.
(your current and future peers will either thank you immensely or curse you out—depending on how well you understand and implement this. This is a world of dragons, fwiw.)</li>
</ol>
<p>and, for the love of all that’s holy, please go with the simpler option!! PLEASE!</p>
<h2 id="maybe-lets-switch-gears">Maybe lets switch gears?</h2>
<h3 id="read-write-locks-the-bookworms-paradise">Read-Write Locks: The Bookworm&rsquo;s Paradise</h3>
<p>When you have many readers and few writers, a read-write lock can significantly improve performance.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">AsyncReadWriteLock</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">SemaphoreSlim</span> <span class="n">_readSemaphore</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SemaphoreSlim</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">SemaphoreSlim</span> <span class="n">_writeSemaphore</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SemaphoreSlim</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">_readCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IDisposable</span><span class="p">&gt;</span> <span class="n">ReadLockAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">_readSemaphore</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">_readCount</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="n">_writeSemaphore</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_readSemaphore</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">AsyncDisposable</span><span class="p">(</span><span class="kd">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="n">_readSemaphore</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">_readCount</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_writeSemaphore</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_readSemaphore</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IDisposable</span><span class="p">&gt;</span> <span class="n">WriteLockAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">_writeSemaphore</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">AsyncDisposable</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="n">_writeSemaphore</span><span class="p">.</span><span class="n">Release</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">class</span> <span class="nc">AsyncDisposable</span> <span class="p">:</span> <span class="n">IDisposable</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">_releaseAction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">bool</span> <span class="n">_isDisposed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">AsyncDisposable</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">releaseAction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_releaseAction</span> <span class="p">=</span> <span class="n">releaseAction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_isDisposed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_isDisposed</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_releaseAction</span><span class="p">().</span><span class="n">GetAwaiter</span><span class="p">().</span><span class="n">GetResult</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>and that could be used in a potential real-world use case like this -</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ThreadSafeCache</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">_cache</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">AsyncReadWriteLock</span> <span class="n">_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AsyncReadWriteLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetOrAddAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">valueFactory</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="p">(</span><span class="k">await</span> <span class="n">_lock</span><span class="p">.</span><span class="n">ReadLockAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_cache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">string</span> <span class="k">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="p">(</span><span class="k">await</span> <span class="n">_lock</span><span class="p">.</span><span class="n">WriteLockAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Double-check in case another thread added the value</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_cache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">string</span> <span class="k">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">newValue</span> <span class="p">=</span> <span class="k">await</span> <span class="n">valueFactory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">newValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">newValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span> <span class="n">UpdateAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="p">(</span><span class="k">await</span> <span class="n">_lock</span><span class="p">.</span><span class="n">WriteLockAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And, a runsheet (atleast, for me) for these &lsquo;real-world&rsquo; use cases:</p>
<ol>
<li>Correct Lock Usage: We properly release locks using using statements, ensuring they&rsquo;re always released even if exceptions occur.</li>
<li>Double-Checked Locking: We first check under a read lock, then under a write lock, minimizing the time spent holding the more expensive write lock.</li>
<li>Async Operations: Both reading and writing support asynchronous operations, crucial for maintaining responsiveness in real-world applications.</li>
<li>Cancellation Support: All methods accept a CancellationToken, allowing operations to be cancelled gracefully.</li>
</ol>
<h3 id="lock-free-algorithms-living-on-the-edge">Lock-Free Algorithms: Living on the Edge</h3>
<p>For the truly brave (or foolhardy), lock-free algorithms offer the promise of high performance without the overhead of locks. But beware, here be dragons.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">LockFreeStack</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">class</span> <span class="nc">Node</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">T</span> <span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Node</span> <span class="n">Next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">int</span> <span class="n">Version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span> <span class="k">value</span><span class="p">,</span> <span class="n">Node</span> <span class="n">next</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Version</span> <span class="p">=</span> <span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Node</span> <span class="n">_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">_operationCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Push</span><span class="p">(</span><span class="n">T</span> <span class="k">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">newNode</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">oldHead</span> <span class="p">=</span> <span class="n">_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newNode</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">oldHead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">_head</span><span class="p">,</span> <span class="n">newNode</span><span class="p">,</span> <span class="n">oldHead</span><span class="p">)</span> <span class="p">==</span> <span class="n">oldHead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">_operationCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Yield</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">TryPop</span><span class="p">(</span><span class="k">out</span> <span class="n">T</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">oldHead</span> <span class="p">=</span> <span class="n">_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">oldHead</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">newHead</span> <span class="p">=</span> <span class="n">oldHead</span><span class="p">.</span><span class="n">Next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">_head</span><span class="p">,</span> <span class="n">newHead</span><span class="p">,</span> <span class="n">oldHead</span><span class="p">)</span> <span class="p">==</span> <span class="n">oldHead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="p">=</span> <span class="n">oldHead</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">_operationCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Ensure the node can&#39;t be reused until all ongoing operations that might have seen it complete</span>
</span></span><span class="line"><span class="cl">                <span class="n">SpinWait</span><span class="p">.</span><span class="n">SpinUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Volatile</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="k">ref</span> <span class="n">_operationCount</span><span class="p">)</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Yield</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">long</span> <span class="n">OperationCount</span> <span class="p">=&gt;</span> <span class="n">Volatile</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="k">ref</span> <span class="n">_operationCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And, the runsheet here (again, atleast for me):</p>
<ol>
<li>ABA Problem Mitigation!</li>
<li>Operation Counting: The <code>_operationCount</code> field keeps track of the number of push and pop operations. This can be useful for monitoring and debugging purposes.</li>
<li>Memory Ordering: Use <code>Volatile.Read</code> to ensure proper memory ordering when reading the operation count.</li>
<li>Backoff Strategy: Use <code>Thread.Yield()</code> instead of busy-waiting, which can improve performance in high-contention scenarios by allowing other threads to make progress.</li>
<li>Safe Memory Reclamation: The <code>SpinWait.SpinUntil</code> in TryPop ensures that a popped node isn&rsquo;t immediately reused, preventing potential issues with ongoing operations.</li>
</ol>
<p>A potential application for lock-free algorithms? A logging system! Nothing can get busier, imho.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">HighPerformanceLogger</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">LockFreeStack</span><span class="p">&lt;</span><span class="n">LogEntry</span><span class="p">&gt;</span> <span class="n">_logBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LockFreeStack</span><span class="p">&lt;</span><span class="n">LogEntry</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">Thread</span> <span class="n">_logWriterThread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">bool</span> <span class="n">_isRunning</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">AutoResetEvent</span> <span class="n">_newLogEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">HighPerformanceLogger</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logWriterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">LogWriterLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logWriterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">LogLevel</span> <span class="n">level</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logBuffer</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="k">new</span> <span class="n">LogEntry</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">_newLogEvent</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">LogWriterLoop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">_isRunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_logBuffer</span><span class="p">.</span><span class="n">TryPop</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">logEntry</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// In a real implementation, we&#39;d write to a file or database</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;[{logEntry.Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{logEntry.Level}] {logEntry.Message}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Wait for a new log entry or a timeout. We coulduse `sleep` instead, well.. I don&#39;t like ... sleep, in programming contenxt only though :p</span>
</span></span><span class="line"><span class="cl">                <span class="n">_newLogEvent</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Process any remaining logs after shutdown signal</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">_logBuffer</span><span class="p">.</span><span class="n">TryPop</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">logEntry</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;[{logEntry.Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{logEntry.Level}] {logEntry.Message}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Shutdown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_isRunning</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_newLogEvent</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span> <span class="c1">// Ensure the log writer thread wakes up</span>
</span></span><span class="line"><span class="cl">        <span class="n">_logWriterThread</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_newLogEvent</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">LogLevel</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Debug</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Warning</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Error</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Critical</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ol>
<li>Event-Based Waiting: This allows the log writer thread to efficiently wait for new log entries without consuming CPU cycles.</li>
<li>Decoupled Log Writing: The <code>LogWriterLoop</code> runs on a separate thread, processing log entries asynchronously. This ensures that logging doesn&rsquo;t slow down the main application threads.</li>
<li>Low-Latency: The &rsquo;lock-free&rsquo; nature of our stack means that logging operations (pushes) complete very quickly, minimizing the impact on latency-sensitive operations &ndash; like, whatever it is your company does to save the world!</li>
<li>Graceful Shutdown: The <code>Shutdown</code> method demonstrates how to safely stop the logging thread, ensuring all logs are processed before the application exits.</li>
</ol>
<h1 id="so-what-am-i-saying">So, what am I saying?</h1>
<p>imho, here&rsquo;s a checklist for the discerning engineer:</p>
<ol>
<li>Know Your Tools: Understand the differences between mutexes, semaphores, and other synchronization primitives.</li>
<li>Profile, Profile, Profile: Don&rsquo;t guess at performance bottlenecks. Use profiling tools to identify real issues.</li>
<li>Keep It Simple: Complex synchronization schemes are bug magnets. Simplify where possible. Please&hellip; KISS!</li>
<li>Test Thoroughly: Concurrency bugs are notoriously hard to reproduce. Sometimes impossible to reproduce. So, be ready for 3am calls &ndash; Ah, im sure it will go wrong.. Yup, very very sure&hellip;</li>
<li>Review and Refactor: Regularly review your concurrent code. What made sense yesterday might be a nightmare today.</li>
</ol>
<p>&hellip;[spiderman quote playing in the background]&hellip; Use these tools wisely, and please &ldquo;understand&rdquo; the difference before &rsquo;trying&rsquo; parallelism/threading/concurrency and may your code be ever race-condition free.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
